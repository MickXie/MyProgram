<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Pin Pictures</title>

    <style>
      body {
        font-family: Helvetica, "Microsoft YaHei", "LiHei Pro", TW-Kai;
      }

      #board-container {
        position: relative;
        width: 960px;
        height: 720px;
        float: left;
        border: 0;
      }

      #blackboard {
        width: 960px;
        height: 720px;
      }

      div.nav {
        border: 1px solid skyBlue;
        margin-left: 3px;
        padding: 3px;
        float: left;
      }

      img.picture {
        position: absolute;
        width: 200px;
        height: 200px;
        cursor: move;
      }

      img.pin {
        position: absolute;
        width: 30px;
        pointer-events: none;
      }

      li {
        font-size: 12px;
      }
    </style>
  </head>

  <body>
    <div id="board-container">
      <img id="blackboard" src="blackboard.jpg" />
    </div>

    <!-- 控制區 -->
    <div id="nav" class="nav">
      <form action="#">
        <p>
          <label
            >要放哪個道具圖片:
            <input
              type="number"
              id="pic"
              min="1"
              max="10"
              step="1"
              value="1"
            /> </label
          ><br />

          <label>圖片X座標: <input type="number" id="x" value="40" /> </label
          ><br />

          <label
            >圖片Y座標:
            <input type="number" id="y" value="100" />
          </label>
        </p>

        <p>
          <button type="button" id="addButton">新增圖片</button>
          <button type="button" id="removeAllButton">移除所有圖片</button>
        </p>
      </form>

      <ul>
        <li>[01]任意門</li>
        <li>[02]時光機</li>
        <li>[03]竹蜻蜓</li>
        <li>[04]時光布</li>
        <li>[05]記憶麵包</li>
        <li>[06]縮小燈</li>
        <li>[07]翻譯蒟蒻</li>
        <li>[08]如果電話亭</li>
        <li>[09]穿透環</li>
        <li>[10]更衣照相機</li>
      </ul>
    </div>

    <script>
      const pinColors = ["red.png", "blue.png", "yellow.png"];
      let zTop = 10;
      const board = document.getElementById("board-container");

      window.onload = function () {
        let saved = localStorage.getItem("pins");
        if (saved) {
          JSON.parse(saved).forEach((obj) => {
            createPicture(obj.pic, obj.x, obj.y, obj.pin, obj.id, obj.z);
          });
        }
      };

      document.getElementById("addButton").onclick = function () {
        let picNum = document.getElementById("pic").value;
        let x = parseInt(document.getElementById("x").value);
        let y = parseInt(document.getElementById("y").value);

        let id = "p" + Date.now();
        let rpin = pinColors[Math.floor(Math.random() * 3)];

        createPicture(picNum, x, y, rpin, id, ++zTop);
        saveToLocalStorage();
      };

      document.getElementById("removeAllButton").onclick = function () {
        document
          .querySelectorAll(".picture, .pin")
          .forEach((el) => el.remove());
        localStorage.removeItem("pins");
      };

      function createPicture(picNum, x, y, pin, id, z) {
        let pic = document.createElement("img");
        pic.className = "picture";
        pic.id = id;

        let picName = String(picNum).padStart(2, "0");
        pic.src = picName + ".png";

        pic.style.left = x + "px";
        pic.style.top = y + "px";
        pic.style.zIndex = z;

        let pinImg = document.createElement("img");
        pinImg.className = "pin";
        pinImg.id = id + "-pin";
        pinImg.src = pin;

        pinImg.style.left = x + 85 + "px";
        pinImg.style.top = y - 15 + "px";
        pinImg.style.zIndex = z + 1;

        board.appendChild(pic);
        board.appendChild(pinImg);

        enableDrag(pic, pinImg);
      }

      function enableDrag(pic, pinImg) {
        let offsetX, offsetY;
        let dragging = false;

        pic.onmousedown = function (e) {
          dragging = true;
          offsetX = e.offsetX;
          offsetY = e.offsetY;

          pic.style.zIndex = ++zTop;
          pinImg.style.zIndex = zTop + 1;
        };

        document.onmousemove = function (e) {
          if (!dragging) return;

          let rect = board.getBoundingClientRect();
          let newX = e.clientX - rect.left - offsetX;
          let newY = e.clientY - rect.top - offsetY;

          newX = Math.max(0, Math.min(newX, board.clientWidth - 200));
          newY = Math.max(0, Math.min(newY, board.clientHeight - 200));

          pic.style.left = newX + "px";
          pic.style.top = newY + "px";

          pinImg.style.left = newX + 85 + "px";
          pinImg.style.top = newY - 15 + "px";
        };

        document.onmouseup = function () {
          if (dragging) {
            dragging = false;
            saveToLocalStorage();
          }
        };
      }

      function saveToLocalStorage() {
        let items = [];
        document.querySelectorAll(".picture").forEach((pic) => {
          let pin = document.getElementById(pic.id + "-pin");
          items.push({
            id: pic.id,
            pic: pic.src.split("/").pop().replace(".png", ""),
            x: parseInt(pic.style.left),
            y: parseInt(pic.style.top),
            pin: pin.src.split("/").pop(),
            z: parseInt(pic.style.zIndex),
          });
        });

        localStorage.setItem("pins", JSON.stringify(items));
      }
    </script>
  </body>
</html>
